<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cryo Bullz (Local Storage)</title>
    <style>
        /* General body styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        /* Centered main heading */
        h2 {
            color: #2c3e50;
            text-align: center;
        }

        /* Container for overall layout */
        .container {
            max-width: 1200px;
            margin: auto;
        }

        /* Card-like sections for better organization */
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Form group layout for input fields and buttons */
        .form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        /* Styling for text inputs, file inputs, password inputs, and selects */
        input[type="text"],
        input[type="file"],
        input[type="password"],
        select {
            flex: 1; /* Allows items to grow and shrink */
            min-width: 150px; /* Minimum width for inputs */
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        /* General button styling */
        button {
            background-color: #3498db;
            border: none;
            color: white;
            padding: 10px 16px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s; /* Smooth transition for hover effects */
            flex-shrink: 0; /* Prevents button from shrinking in flex container */
        }

        /* Button hover effect */
        button:hover {
            background-color: #2980b9;
        }

        /* Specific button colors for delete, edit, and match actions */
        .btn.delete { background-color: #e74c3c; }
        .btn.delete:hover { background-color: #c0392b; }
        .btn.edit { background-color: #f39c12; }
        .btn.edit:hover { background-color: #d68910; }
        .btn.match { background-color: #2ecc71; }
        .btn.match:hover { background-color: #27ae60; }

        /* Section header styling */
        .section-header {
            font-size: 20px;
            margin-bottom: 10px;
            color: #333;
        }

        /* Utility class to hide elements */
        .hidden {
            display: none;
        }

        /* Spacing for action buttons within a row */
        .actions button {
            margin: 0 4px;
        }

        /* Responsive table wrapper for horizontal scrolling on small screens */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS devices */
        }

        /* General table styling */
        table {
            width: 100%;
            border-collapse: collapse; /* Collapse borders between cells */
            min-width: 1100px; /* Ensure table doesn't get too narrow, enabling horizontal scroll if needed */
        }
        /* Override min-width for smaller tables like top players */
        .top-players-table {
            min-width: unset;
        }

        /* Table header and data cell styling */
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping in cells */
        }

        /* Table header specific styling */
        th {
            background-color: #34495e;
            color: white;
        }

        /* Media Queries for Mobile Responsiveness */
        @media (max-width: 768px) {
            /* Stack form elements vertically */
            .form-group {
                flex-direction: column;
                align-items: stretch;
            }

            /* Make inputs and buttons take full width on mobile */
            button, input[type="text"], input[type="file"], input[type="password"], select {
                width: 100%;
                min-width: unset;
            }

            /* Adjust card padding */
            .card {
                padding: 15px;
            }

            /* Adjust font size for section headers */
            .section-header {
                font-size: 18px;
            }

            /* Reduce table font size on mobile */
            table {
                font-size: 12px;
            }
            .top-players-table {
                font-size: 12px;
            }

            /* Reduce cell padding on mobile */
            th, td {
                padding: 8px;
            }
        }

        /* Highlight styles for top players */
        .batting-top {
            background-color: #fc6805 !important; /* Orange */
            font-weight: bold;
            color: white;
        }

        .bowling-top {
            background-color: #8409f7 !important; /* Purple */
            font-weight: bold;
            color: white;
        }

        /* Gradient for players who are top in both batting and bowling */
        .double-top {
            background: linear-gradient(90deg, #fc6805 50%, #8409f7 50%);
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Cryo Bullz (Local Storage)</h2>

        <!-- Admin Login/Logout Section -->
        <div class="card">
            <div class="form-group" id="admin-login-controls">
                <input type="password" id="admin-password" placeholder="Admin Password" />
                <button onclick="adminLogin()">Login as Admin</button>
            </div>
            <div class="form-group hidden" id="admin-logout-controls">
                <span>Logged in as Admin.</span>
                <button onclick="adminLogout()">Logout Admin</button>
            </div>

            <!-- Admin Player Management Controls (hidden by default) -->
            <div id="admin-player-controls" class="hidden">
                <div class="form-group">
                    <input type="text" id="name" placeholder="Enter Player Name" />
                    <select id="role">
                        <option value="">Select Role</option>
                        <option value="Batter">Batter</option>
                        <option value="Bowler">Bowler</option>
                        <option value="All-rounder">All-rounder</option>
                        <option value="Wicketkeeper">Wicketkeeper</option>
                    </select>
                    <input type="text" id="battingStyle" placeholder="Batting Style (e.g., Right-hand Bat)" />
                    <input type="text" id="bowlingStyle" placeholder="Bowling Style (e.g., Left-arm Orthodox)" />
                    <button onclick="addPlayer()">Add Player</button>
                </div>

                <div class="form-group">
                    <button onclick="exportToJSON()">Export JSON</button>
                    <button onclick="exportToCSV()">Export CSV</button>
                    <input type="file" id="import-file" accept=".json" onchange="importFromJSON(event)" />
                </div>
            </div>
        </div>

        <!-- Player Stats Table Section -->
        <div class="card">
            <div class="section-header">Player Stats</div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Player</th>
                            <th>Role</th>
                            <th>Batting Style</th>
                            <th>Bowling Style</th>
                            <th>Matches</th>
                            <th>Innings</th>
                            <th>Runs</th>
                            <th>Wickets</th>
                            <th>Catches</th>
                            <th>Stumpings</th>
                            <th>Run Outs</th>
                            <th>Bat Avg</th>
                            <th>Economy</th>
                            <th>Strike Rate</th>
                            <th>Bowling Avg</th>
                            <th class="admin-actions-col hidden">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="player-list"></tbody>
                </table>
            </div>
        </div>

        <!-- Match Section (hidden by default, shown when a player's matches are viewed) -->
        <div class="card hidden" id="match-section">
            <div class="section-header">Matches for <span id="match-player-name"></span></div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr><th>#</th><th>Runs</th><th>Wickets</th><th>Overs</th><th>Conceded</th><th class="admin-actions-col hidden">Actions</th></tr>
                    </thead>
                    <tbody id="match-list"></tbody>
                </table>
            </div>
            <!-- Admin Match Controls (hidden by default, only shown if admin and matches open) -->
            <div style="margin-top: 10px;" id="admin-match-controls" class="hidden">
                <button onclick="addMatch()">+ Add Match</button>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="closeMatchSection()">Close</button>
            </div>
        </div>

        <!-- Top 3 Batters Table Section -->
        <div class="card">
            <div class="section-header">Top 3 Batters (by Runs)</div>
            <div class="table-responsive">
                <table class="top-players-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Runs</th>
                            <th>Matches</th>
                            <th>Bat Avg</th>
                        </tr>
                    </thead>
                    <tbody id="top-batters-list">
                        <tr><td colspan="5">No data available</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top 3 Bowlers Table Section -->
        <div class="card">
            <div class="section-header">Top 3 Bowlers (by Wickets)</div>
            <div class="table-responsive">
                <table class="top-players-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Wickets</th>
                            <th>Matches</th>
                            <th>Bowling Avg</th>
                        </tr>
                    </thead>
                    <tbody id="top-bowlers-list">
                        <tr><td colspan="5">No data available</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        let players = []; // Stores the fetched player data, including nested matches
        let currentPlayerId = null; // Stores the ID of the player whose matches are currently being viewed
        let isAdmin = false; // Flag to track admin login status
        const ADMIN_PASSWORD = "admin"; // WARNING: This is a hardcoded password and is NOT secure for production.
                                        // For a real application, implement proper user authentication.

        // Local Storage Keys
        const LOCAL_STORAGE_PLAYERS_KEY = 'cryoBullzPlayers';
        const LOCAL_STORAGE_NEXT_PLAYER_ID_KEY = 'cryoBullzNextPlayerId';
        const LOCAL_STORAGE_NEXT_MATCH_ID_KEY = 'cryoBullzNextMatchId';

        let nextPlayerId = 1; // Tracks the next available player ID for new entries
        let nextMatchId = 1;   // Tracks the next available match ID for new entries

        // DOM elements that need their visibility controlled based on admin status
        const adminLoginControls = document.getElementById('admin-login-controls');
        const adminLogoutControls = document.getElementById('admin-logout-controls');
        const adminPlayerControls = document.getElementById('admin-player-controls');
        const adminMatchControls = document.getElementById('admin-match-controls');
        const matchSection = document.getElementById('match-section');

        // --- Local Storage Functions ---

        /**
         * Loads data from localStorage into the 'players' array and ID counters.
         * This runs on application startup.
         */
        function loadFromLocalStorage() {
            try {
                const storedPlayers = localStorage.getItem(LOCAL_STORAGE_PLAYERS_KEY);
                if (storedPlayers) {
                    players = JSON.parse(storedPlayers);
                } else {
                    players = [];
                }

                const storedNextPlayerId = localStorage.getItem(LOCAL_STORAGE_NEXT_PLAYER_ID_KEY);
                if (storedNextPlayerId) {
                    nextPlayerId = parseInt(storedNextPlayerId);
                } else {
                    nextPlayerId = 1;
                }

                const storedNextMatchId = localStorage.getItem(LOCAL_STORAGE_NEXT_MATCH_ID_KEY);
                if (storedNextMatchId) {
                    nextMatchId = parseInt(storedNextNextMatchId);
                } else {
                    nextMatchId = 1;
                }
            } catch (e) {
                console.error("Error loading from local storage:", e);
                // Fallback to empty state if loading fails
                players = [];
                nextPlayerId = 1;
                nextMatchId = 1;
            }
        }

        /**
         * Saves the current 'players' array and ID counters to localStorage.
         * This function should be called after any modification to the data.
         */
        function saveToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_PLAYERS_KEY, JSON.stringify(players));
                localStorage.setItem(LOCAL_STORAGE_NEXT_PLAYER_ID_KEY, nextPlayerId.toString());
                localStorage.setItem(LOCAL_STORAGE_NEXT_MATCH_ID_KEY, nextMatchId.toString());
            } catch (e) {
                console.error("Error saving to local storage:", e);
                alert("Failed to save data to your browser's local storage. Your changes might not persist.");
            }
        }

        // --- Admin Control Functions ---

        /**
         * Updates the visibility of admin-specific UI elements based on the isAdmin flag.
         */
        function updateAdminVisibility() {
            if (isAdmin) {
                adminLoginControls.classList.add('hidden');    // Hide login form
                adminLogoutControls.classList.remove('hidden'); // Show logout button
                adminPlayerControls.classList.remove('hidden'); // Show player add/export controls
                
                // Admin match controls are only visible if admin AND a player's matches are open
                if (currentPlayerId !== null) {
                    adminMatchControls.classList.remove('hidden');
                } else {
                    adminMatchControls.classList.add('hidden'); // Ensure hidden if no player selected
                }
                // Show action columns (Delete, Edit buttons in tables)
                document.querySelectorAll('.admin-actions-col').forEach(el => el.classList.remove('hidden'));
            } else {
                adminLoginControls.classList.remove('hidden');  // Show login form
                adminLogoutControls.classList.add('hidden');   // Hide logout button
                adminPlayerControls.classList.add('hidden');   // Hide player add/export controls
                adminMatchControls.classList.add('hidden');    // Hide match add controls
                document.getElementById('admin-password').value = ''; // Clear password input
                // Hide action columns
                document.querySelectorAll('.admin-actions-col').forEach(el => el.classList.add('hidden'));
            }
            // Re-render players table to apply updated visibility to action buttons
            renderPlayers();
            // If a match section is open, re-render its buttons too.
            if (currentPlayerId !== null) {
                const player = players.find(p => p.id === currentPlayerId);
                if (player) {
                    renderMatches(player.matches); // Render matches with updated admin visibility.
                }
            }
        }

        /**
         * Attempts to log in as admin.
         */
        function adminLogin() {
            const passwordInput = document.getElementById('admin-password');
            if (passwordInput.value === ADMIN_PASSWORD) {
                isAdmin = true;
                updateAdminVisibility(); // Update UI
                alert("Logged in as Admin!");
            } else {
                alert("Incorrect password!");
                passwordInput.value = ''; // Clear password on failure
            }
        }

        /**
         * Logs out from admin mode.
         */
        function adminLogout() {
            isAdmin = false;
            updateAdminVisibility(); // Update UI
            alert("Logged out of Admin mode.");
        }

        // --- Data Calculation Function (Client-Side) ---

        /**
         * Calculates and returns aggregated statistics for a given array of match objects.
         * This function processes raw match data to derive batting average, bowling average, etc.
         * @param {Array<Object>} matches - An array of match objects for a single player.
         * @returns {Object} An object containing aggregated statistics.
         */
        function calculateStats(matches) {
            let innings = 0;
            let runs = 0;
            let wickets = 0;
            let overs = 0; // Total overs bowled (e.g., 5.3 overs)
            let conceded = 0;
            let totalBallsFaced = 0;
            let totalCatches = 0;
            let totalStumpings = 0;
            let totalRunOuts = 0;

            matches.forEach(m => {
                if (m.did_bat) {
                    innings++;
                    totalBallsFaced += (m.balls || 0); // Use 0 if balls is null/undefined
                }
                runs += m.runs || 0;
                wickets += m.wickets || 0;
                overs += m.overs || 0;
                conceded += m.conceded || 0;
                totalCatches += (m.catches || 0);
                totalStumpings += (m.stumpings || 0);
                totalRunOuts += (m.run_outs || 0);
            });

            // Calculate averages and strike rates, handling division by zero
            const avg = innings ? (runs / innings).toFixed(2) : '-';
            const sr = totalBallsFaced ? ((runs / totalBallsFaced) * 100).toFixed(2) : '-';
            const eco = overs ? (conceded / overs).toFixed(2) : '-';
            const bowlAvg = wickets ? (conceded / wickets).toFixed(2) : '-';

            return {
                matches: matches.length,
                innings,
                runs,
                wickets,
                avg, // Batting Average
                sr,  // Batting Strike Rate
                eco, // Bowling Economy
                bowlAvg, // Bowling Average
                totalCatches,
                totalStumpings,
                totalRunOuts
            };
        }

        // --- Data Management & Rendering Functions (Local Storage) ---

        /**
         * Renders the list of players and their aggregated stats in the main table.
         * Data is loaded from the 'players' array (which is synced with localStorage).
         */
        function renderPlayers() {
            const tbody = document.getElementById('player-list');
            tbody.innerHTML = ''; // Clear existing table rows

            let topBatIndex = -1;
            let topBowlIndex = -1;
            let maxRuns = -1;
            let maxWickets = -1;

            // Loop through players to determine who is the top batter and top bowler
            players.forEach((player, i) => {
                const stats = calculateStats(player.matches);

                // Check for top batter (based on runs, only if they have batted)
                if (stats.runs > maxRuns && stats.innings > 0) {
                    maxRuns = stats.runs;
                    topBatIndex = i;
                }

                // Check for top bowler (based on wickets, only if they have bowled)
                if (stats.wickets > maxWickets && stats.wickets > 0) {
                    maxWickets = stats.wickets;
                    topBowlIndex = i;
                }
            });

            // Populate the main player table
            if (players.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="16">No players added yet. Add a player above!</td></tr>';
            } else {
                players.forEach((player, index) => {
                    const stats = calculateStats(player.matches);

                    let rowClass = '';
                    const isTopBatter = (index === topBatIndex && stats.runs > 0);
                    const isTopBowler = (index === topBowlIndex && stats.wickets > 0);

                    // Determine highlight class for the row
                    if (isTopBatter && isTopBowler) {
                        rowClass = 'double-top';
                    } else if (isTopBatter) {
                        rowClass = 'batting-top';
                    } else if (isTopBowler) {
                        rowClass = 'bowling-top';
                    }

                    // HTML for action buttons (Matches and Delete)
                    // Delete button is conditionally visible based on isAdmin
                    const actionButtons = `
                        <button class="btn match" onclick="viewMatches(${player.id})">Matches</button>
                        <button class="btn delete ${isAdmin ? '' : 'hidden'}" onclick="deletePlayer(${player.id})">Delete</button>
                    `;

                    // Construct the table row HTML
                    const row = `
                        <tr class="${rowClass}">
                            <td>${index + 1}</td>
                            <td>${player.name}</td>
                            <td>${player.role || '-'}</td>
                            <td>${player.batting_style || '-'}</td>
                            <td>${player.bowling_style || '-'}</td>
                            <td>${stats.matches}</td>
                            <td>${stats.innings}</td>
                            <td>${stats.runs}</td>
                            <td>${stats.wickets}</td>
                            <td>${stats.totalCatches}</td>
                            <td>${stats.totalStumpings}</td>
                            <td>${stats.totalRunOuts}</td>
                            <td>${stats.avg}</td>
                            <td>${stats.eco}</td>
                            <td>${stats.sr}</td>
                            <td>${stats.bowlAvg}</td>
                            <td class="actions admin-actions-col ${isAdmin ? '' : 'hidden'}">
                                ${actionButtons}
                            </td>
                        </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row); // Add row to table body
                });
            }

            // After rendering players, render the top batters and bowlers sections
            renderTopBatters();
            renderTopBowlers();
        }

        /**
         * Adds a new player to the 'players' array and saves to localStorage.
         */
        function addPlayer() {
            if (!isAdmin) {
                alert("You must be logged in as Admin to add players.");
                return;
            }
            // Get values from input fields
            const nameInput = document.getElementById('name');
            const roleInput = document.getElementById('role');
            const battingStyleInput = document.getElementById('battingStyle');
            const bowlingStyleInput = document.getElementById('bowlingStyle');

            const name = nameInput.value.trim();
            const role = roleInput.value;
            const batting_style = battingStyleInput.value.trim();
            const bowling_style = bowlingStyleInput.value.trim();

            if (!name) {
                alert("Player name cannot be empty!");
                return;
            }

            // Check for existing player name to prevent duplicates (case-insensitive)
            if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert("Player with this name already exists!");
                return;
            }

            const newPlayer = {
                id: nextPlayerId++, // Assign current ID and then increment
                name: name,
                role: role,
                batting_style: batting_style,
                bowling_style: bowling_style,
                matches: [] // New players start with no matches
            };

            players.push(newPlayer); // Add new player to local array
            saveToLocalStorage();     // Save updated array to localStorage
            renderPlayers();          // Re-render the player list to show the new player

            // Clear input fields after successful addition
            nameInput.value = '';
            roleInput.value = '';
            battingStyleInput.value = '';
            bowlingStyleInput.value = '';
            alert("Player added successfully!");
        }

        /**
         * Deletes a player and all their associated match data from the 'players' array and localStorage.
         * @param {number} playerId - The ID of the player to delete.
         */
        function deletePlayer(playerId) {
            if (!isAdmin) {
                alert("You must be logged in as Admin to delete players.");
                return;
            }
            // Confirm deletion with the user
            if (confirm("Are you sure you want to delete this player? This will also delete all their match data.")) {
                // Filter out the player to be deleted
                players = players.filter(p => p.id !== playerId);
                saveToLocalStorage(); // Save updated array to localStorage
                renderPlayers();      // Re-render the player list
                closeMatchSection();  // Close match section if the deleted player's matches were open
                alert("Player deleted successfully!");
            }
        }

        /**
         * Displays the match history for a selected player.
         * @param {number} playerId - The ID of the player whose matches to view.
         */
        function viewMatches(playerId) {
            currentPlayerId = playerId; // Set the currently viewed player ID
            const player = players.find(p => p.id === playerId);
            if (player) {
                document.getElementById('match-player-name').innerText = player.name; // Update section title
                matchSection.classList.remove('hidden'); // Show the match section
                renderMatches(player.matches); // Render the matches for this player
                updateAdminVisibility(); // Update admin controls visibility (e.g., add match button)
            } else {
                alert("Player not found!");
                closeMatchSection();
            }
        }

        /**
         * Renders the list of matches for the currently selected player in the match section table.
         * @param {Array<Object>} matchesData - An array of match objects to render.
         */
        function renderMatches(matchesData) {
            const matchList = document.getElementById('match-list');
            matchList.innerHTML = ''; // Clear existing rows
            const matches = matchesData || []; // Ensure matches is an array

            if (matches.length === 0) {
                matchList.innerHTML = '<tr><td colspan="6">No matches recorded for this player.</td></tr>';
                return;
            }

            matches.forEach((m, i) => {
                // Action buttons for each match (Edit, Delete)
                // These are only visible if isAdmin is true
                const actionButtons = isAdmin ? `
                    <button class="btn edit" onclick="editMatch(${m.id})">Edit</button>
                    <button class="btn delete" onclick="deleteMatch(${m.id})">Delete</button>
                ` : '';

                // Construct the match table row HTML
                const row = `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${m.runs}</td>
                        <td>${m.wickets}</td>
                        <td>${m.overs}</td>
                        <td>${m.conceded}</td>
                        <td class="admin-actions-col ${isAdmin ? '' : 'hidden'}">
                            ${actionButtons}
                        </td>
                    </tr>`;
                matchList.insertAdjacentHTML('beforeend', row); // Add row to table body
            });
        }

        /**
         * Prompts the user for new match details and adds it to the current player's matches.
         */
        function addMatch() {
            if (!isAdmin) {
                alert("You must be logged in as Admin to add matches.");
                return;
            }
            if (currentPlayerId === null) {
                alert("Please select a player first.");
                return;
            }

            const player = players.find(p => p.id === currentPlayerId);
            if (!player) {
                alert("Selected player not found.");
                return;
            }

            // Prompt user for match details (using confirm/prompt - basic UI for this example)
            const did_bat = confirm("Did the player bat in this match?");
            const runs = did_bat ? parseInt(prompt("Runs scored:", "0")) || 0 : 0;
            const balls = did_bat ? parseInt(prompt("Balls faced:", "0")) || 0 : 0;
            const wickets = parseInt(prompt("Wickets taken:", "0")) || 0;
            const overs = parseFloat(prompt("Overs bowled:", "0")) || 0;
            const conceded = parseInt(prompt("Runs conceded:", "0")) || 0;

            let catches = 0;
            let stumpings = 0;
            let run_outs = 0;

            // Prompt for specific fielding stats based on player role
            if (player.role === "Wicketkeeper") {
                catches = parseInt(prompt("Catches taken (Wicketkeeper):", "0")) || 0;
                stumpings = parseInt(prompt("Stumpings effected (Wicketkeeper):", "0")) || 0;
                run_outs = parseInt(prompt("Run Outs effected (Wicketkeeper, Direct Hits/Assists):", "0")) || 0;
            } else {
                catches = parseInt(prompt("Catches taken (Fielder):", "0")) || 0;
                stumpings = 0; // Fielders don't effect stumpings
                run_outs = 0; // Fielders typically don't directly effect run outs in the same way as WK
            }

            const newMatch = {
                id: nextMatchId++, // Assign current ID and then increment
                player_id: currentPlayerId,
                did_bat,
                runs,
                balls,
                wickets,
                overs,
                conceded,
                catches,
                stumpings,
                run_outs
            };

            player.matches.push(newMatch); // Add new match to player's matches array
            saveToLocalStorage();           // Save updated players array to localStorage
            renderMatches(player.matches);  // Re-render matches for the current player
            renderPlayers();                // Re-render main players table to update aggregated stats
            alert("Match added successfully!");
        }

        /**
         * Prompts to edit an existing match's details.
         * @param {number} matchId - The ID of the match to edit.
         */
        function editMatch(matchId) {
            if (!isAdmin) {
                alert("You must be logged in as Admin to edit matches.");
                return;
            }
            if (currentPlayerId === null) {
                alert("No player selected.");
                return;
            }

            const player = players.find(p => p.id === currentPlayerId);
            if (!player) {
                alert("Selected player not found for match edit.");
                return;
            }

            const currentMatch = player.matches.find(m => m.id === matchId);
            if (!currentMatch) {
                alert("Match not found for editing.");
                return;
            }

            // Prompt user for updated match details, pre-filling with current values
            const did_bat = confirm(`Did the player bat in this match? (Currently: ${currentMatch.did_bat})`);
            const runs = did_bat ? parseInt(prompt("Runs scored:", currentMatch.runs)) || 0 : 0;
            const balls = did_bat ? parseInt(prompt("Balls faced:", currentMatch.balls || 0)) || 0 : 0;
            const wickets = parseInt(prompt("Wickets taken:", currentMatch.wickets)) || 0;
            const overs = parseFloat(prompt("Overs bowled:", currentMatch.overs)) || 0;
            const conceded = parseInt(prompt("Runs conceded:", currentMatch.conceded)) || 0;

            let catches = currentMatch.catches || 0;
            let stumpings = currentMatch.stumpings || 0;
            let run_outs = currentMatch.run_outs || 0;

            if (player.role === "Wicketkeeper") {
                catches = parseInt(prompt("Catches taken (Wicketkeeper):", currentMatch.catches || "0")) || 0;
                stumpings = parseInt(prompt("Stumpings effected (Wicketkeeper):", currentMatch.stumpings || "0")) || 0;
                run_outs = parseInt(prompt("Run Outs effected (Wicketkeeper, Direct Hits/Assists):", currentMatch.run_outs || "0")) || 0;
            } else {
                catches = parseInt(prompt("Catches taken (Fielder):", currentMatch.catches || "0")) || 0;
                stumpings = 0;
                run_outs = 0;
            }
            
            // Update the current match object directly
            currentMatch.did_bat = did_bat;
            currentMatch.runs = runs;
            currentMatch.balls = balls;
            currentMatch.wickets = wickets;
            currentMatch.overs = overs;
            currentMatch.conceded = conceded;
            currentMatch.catches = catches;
            currentMatch.stumpings = stumpings;
            currentMatch.run_outs = run_outs;

            saveToLocalStorage();           // Save updated players array to localStorage
            renderMatches(player.matches);  // Re-render matches for the current player
            renderPlayers();                // Re-render main players table to update aggregated stats
            alert("Match updated successfully!");
        }

        /**
         * Deletes a specific match from a player's matches array and updates localStorage.
         * @param {number} matchId - The ID of the match to delete.
         */
        function deleteMatch(matchId) {
            if (!isAdmin) {
                alert("You must be logged in as Admin to delete matches.");
                return;
            }
            if (currentPlayerId === null) {
                alert("No player selected for match deletion.");
                return;
            }

            const player = players.find(p => p.id === currentPlayerId);
            if (!player) {
                alert("Selected player not found.");
                return;
            }

            if (confirm("Delete this match?")) {
                // Filter out the match to be deleted from the player's matches array
                player.matches = player.matches.filter(m => m.id !== matchId);
                saveToLocalStorage();           // Save updated players array to localStorage
                renderMatches(player.matches);  // Re-render matches for the current player
                renderPlayers();                // Re-render main players table to update aggregated stats
                alert("Match deleted successfully!");
            }
        }

        /**
         * Closes the match history section and resets the currentPlayerId.
         */
        function closeMatchSection() {
            currentPlayerId = null;
            matchSection.classList.add('hidden'); // Hide the match section
            adminMatchControls.classList.add('hidden'); // Hide match-specific admin controls
        }

        // --- Data Export/Import Functions (Client-Side) ---

        /**
         * Exports the current player data (from the client-side 'players' array) to a JSON file.
         */
        function exportToJSON() {
            const dataStr = JSON.stringify(players, null, 2); // Pretty-print JSON
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "cryo_bullz_players.json"; // Suggested file name
            a.click(); // Programmatically click the link to trigger download
            URL.revokeObjectURL(url); // Clean up the URL object
        }

        /**
         * Exports the current player data to a CSV file.
         * Includes aggregated stats.
         */
        function exportToCSV() {
            // Define CSV headers
            const headers = ["Name", "Role", "Batting Style", "Bowling Style", "Matches", "Innings", "Runs", "Wickets", "Catches", "Stumpings", "Run Outs", "Bat Avg", "Economy", "Strike Rate", "Bowling Avg"];
            
            // Map player data to CSV rows, calculating stats for each
            const rows = players.map(p => {
                const stats = calculateStats(p.matches);
                return [
                    p.name,
                    p.role || '',
                    p.batting_style || '',
                    p.bowling_style || '',
                    stats.matches,
                    stats.innings,
                    stats.runs,
                    stats.wickets,
                    stats.totalCatches,
                    stats.totalStumpings,
                    stats.totalRunOuts,
                    stats.avg,
                    stats.eco,
                    stats.sr,
                    stats.bowlAvg
                ];
            });

            // Format rows into CSV string, handling commas and quotes in data fields
            const csv = [
                headers.join(","), // Join headers with commas
                ...rows.map(r => r.map(field => `"${String(field).replace(/"/g, '""')}"`).join(",")) // Quote fields and escape existing quotes
            ].join("\n"); // Join rows with newlines

            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "cryo_bullz_players.csv";
            a.click();
            URL.revokeObjectURL(url);
        }

        /**
         * Imports player data from a selected JSON file into the client-side 'players' array.
         * This overwrites existing data in localStorage.
         * @param {Event} event - The change event from the file input.
         */
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        players = importedData; // Overwrite current client-side data
                        
                        // Recalculate next IDs based on imported data to avoid conflicts
                        nextPlayerId = 1;
                        nextMatchId = 1;
                        players.forEach(p => {
                            if (p.id >= nextPlayerId) nextPlayerId = p.id + 1;
                            p.matches.forEach(m => {
                                if (m.id >= nextMatchId) nextMatchId = m.id + 1;
                            });
                        });

                        saveToLocalStorage(); // Save the newly imported data
                        renderPlayers();      // Re-render the UI with imported data
                        alert("Import successful! Data has been loaded and saved to your browser's local storage.");
                    } else {
                        alert("Invalid file format. Please select a JSON file containing an array of player objects.");
                    }
                } catch (error) {
                    alert("Error parsing JSON file: " + error.message);
                    console.error("Error importing JSON:", error);
                }
            };
            reader.readAsText(file); // Read the file as text
        }

        // --- Top Players Rendering Functions ---

        /**
         * Renders the top 3 batters table based on runs.
         */
        function renderTopBatters() {
            const tbody = document.getElementById('top-batters-list');
            tbody.innerHTML = ''; // Clear existing rows

            // Filter players who have batted, sort by runs, and take top 3
            const topBatters = players
                .map(player => ({
                    player: player,
                    stats: calculateStats(player.matches)
                }))
                .filter(item => item.stats.innings > 0 && item.stats.runs > 0) // Only consider players who have batted and scored runs
                .sort((a, b) => b.stats.runs - a.stats.runs) // Sort in descending order of runs
                .slice(0, 3); // Take the top 3

            if (topBatters.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                return;
            }

            // Populate the top batters table
            topBatters.forEach((item, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.player.name}</td>
                        <td>${item.stats.runs}</td>
                        <td>${item.stats.matches}</td>
                        <td>${item.stats.avg}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        /**
         * Renders the top 3 bowlers table based on wickets.
         */
        function renderTopBowlers() {
            const tbody = document.getElementById('top-bowlers-list');
            tbody.innerHTML = ''; // Clear existing rows

            // Filter players who have taken wickets, sort by wickets, and take top 3
            const topBowlers = players
                .map(player => ({
                    player: player,
                    stats: calculateStats(player.matches)
                }))
                .filter(item => item.stats.wickets > 0) // Only consider players who have taken wickets
                .sort((a, b) => b.stats.wickets - a.stats.wickets) // Sort in descending order of wickets
                .slice(0, 3); // Take the top 3

            if (topBowlers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                return;
            }

            // Populate the top bowlers table
            topBowlers.forEach((item, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.player.name}</td>
                        <td>${item.stats.wickets}</td>
                        <td>${item.stats.matches}</td>
                        <td>${item.stats.bowlAvg}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- Initial Application Load ---
        // Load data from local storage when the page loads
        loadFromLocalStorage();
        // Render the UI with the loaded data
        renderPlayers();
        // Set initial admin visibility
        updateAdminVisibility();
    </script>
</body>
</html>
